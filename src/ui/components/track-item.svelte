<script lang="ts">
  // import type SpotifyApi from "spotify-api"

  export let track: SpotifyApi.TrackObjectFull;

  function getArtists(artists: SpotifyApi.ArtistObjectSimplified[] = []) {
    return artists.map((a) => a.name);
  }

  async function onTrackClick(event) {
    const { href } = event.target;

    try {
      const res = await (await fetch(href)).json();
      if (res.error) {
        // TODO notify user that a Spotify device must be available
        console.log(res.error.message);
        return;
      }

      // TODO notify user that track is loading
      console.log({ res });
    } catch (error) {
      console.log({ error });
    }
  }

  let artists = getArtists(track.artists).join(", ");
  let searchTerm = `${artists} - ${track.name}`.split(" ").join("+");
  let purchaseLink = `https://www.beatport.com/search?q=${searchTerm}`;
</script>

<style lang="scss">
  .item {
    display: grid;
    grid-template-columns: repeat(10, minmax(10px, 1fr));
    grid-template-rows: repeat(10, minmax(10px, 1fr));

    overflow: hidden;
    max-height: 150px;
  }

  .item__play {
    grid-area: 1 / 1 / -1 / -1;
  }

  .item__img {
    display: block;
    width: 100%;
    height: 100%;

    object-fit: cover;
  }

  .item__play {
    &::before {
      content: "";
      position: absolute;
      inset: 0 0 0 0;
      background: transparent;
    }
  }

  .item__label {
    position: absolute;
    bottom: 0;
    width: 100%;
    margin: 0;
    padding: 0.5rem;
    font-size: 11px;
    background: #000a;
    color: #ccc;

    & span {
      display: block;

      & + span {
        margin-top: 0.5rem;
      }
    }
  }

  .item__purchase {
    --wh: 32px;

    position: absolute;
    inset: 5px 5px auto auto;
    width: var(--wh);
    height: var(--wh);

    padding: 5px;
    border-radius: 3px;
    fill: #94d500;
    background: #262626;
  }

  .artistlink,
  .tracklink {
    color: inherit;
  }

  .artistlink {
    display: inline-block;
    margin-right: 4px;

    &::after {
      content: ",";
    }

    &:last-child::after {
      content: "";
    }
  }

  .tracklink {
    font-style: italic;
  }
</style>

{#if track.id}
  <div class="item">
    <a
      class="item__play"
      href={`/api/play/${track.id}`}
      on:click|self|stopPropagation|preventDefault={onTrackClick}>
      <img
        class="item__img"
        src={track.album.images[1]?.url}
        alt={`Cover art for ${track.album.name}`} />
    </a>
    <!-- <p class="item__label">
      <span class="artists">
        {#each track.artists as artist}
          <a class="artistlink" href="/artist?artistId={artist.id}">{artist.name}</a>
        {/each}
      </span>
      <span><a class="tracklink" href="/track?trackId={track.id}">{track.name}</a></span>
    </p>
    <a class="item__purchase" href={purchaseLink} aria-label="Find on Beatport">
      <svg class="icon" aria-hidden="true">
        <use href="#icon-beatport" />
      </svg>
    </a> -->
  </div>
{/if}
